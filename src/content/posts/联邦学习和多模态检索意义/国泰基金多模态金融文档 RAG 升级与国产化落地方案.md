---
title: 国泰基金多模态金融文档 RAG 升级与国产化落地方案
published: 2026-01-10
description: AI省的的md
image: "./cover.jpg" # 文章封面图（可选）
tags: [实验]
category: 日志
draft: false # 如果设为 true，文章将不会发布
---
# 国泰基金多模态金融文档 RAG 升级与国产化落地方案

在当前金融行业数字化转型的背景下，如何在保证合规与安全的前提下，充分利用人工智能技术对复杂的金融文档进行解析与应用，已经成为一个核心课题。方案的设计不仅要考虑到多模态数据（文本、表格、图表）的处理能力，还要兼顾跨部门协作、数据隔离、算力环境适配等多方面因素。整体架构因此被设计为一个分层、可扩展、可追溯的系统。

## 总体目标

- 本方案旨在构建一个面向金融文档的智能分析平台，能够对 PDF 中的文本、表格与图表进行多模态解析与统一建模，结合向量检索与知识图谱实现高效问答与摘要生成，并在前端提供证据链追溯与图表重绘等可验证功能；系统架构同时引入多租户隔离、细粒度授权、端到端审计与零信任访问机制，确保跨部门协作与联邦共享过程中的数据安全与合规；整体运行环境基于国产软硬件栈，依托昇腾 910B NPU 与国产数据库、中间件和加密算法实现自主可控的部署与评测，从而在保证安全可信的前提下，支撑金融研究、投资与风控等多场景应用。

## 架构方案

## 数据处理与知识构建

金融文档往往包含大量图表与表格，这些信息在传统文本检索中容易被忽略。方案中引入视觉语言模型，将图表与表格转化为 Markdown 结构，并生成自然语言描述，与文本内容统一存储。随后通过嵌入模型生成向量表示，存入向量数据库；同时利用大模型抽取实体与关系，构建知识图谱。这样既能支持语义相似度检索，又能支持基于实体关系的精确查询。

### 核心理念与论文方法映射

- **图表/表格图片→Markdown：**用国产 LVLM 将图表/表格图片转为结构化 Markdown 表，并附要点描述，统一与文本入库，提高视觉信息可检索性与生成忠实度。
- **混合索引：**向量检索（dense+sparse）与图数据库检索（知识图谱）结合，解决“相似度高但不相关”的问题，提高上下文相关性与召回完整性。
- **证据链追溯：**在答案中强制引用页码、图号、来源与数据点，支持证据包导出与审计复核。
- **事实校验与证据链：**生成前对候选上下文事实核验；答案内嵌页码/图号/来源证据，支持前端展开与导出。
- **评测闭环：**RAGAs 指标（忠实度/相关性/上下文精度与召回/端到端正确率）与 BEIR 风格 IR 指标（向量检索）做持续回归。

### 高层组件与数据流

- **联邦层：**Flower FedRAG（共享索引摘要/实体词表/重排器权重），租户隔离与隐私保护。
- **数据层：**对象存储（PDF/图片/证据包）、Milvus（bge-m3 或替代嵌入）、NebulaGraph（实体-关系图）。
- **模型层：**国产 LVLM（MiniCPM-Llama3-V / InternVL）做图片→Markdown；国产 LLM（Qwen 系列）做生成与事实校验；Embedding 用 bge-m3 或 MindSpore 替代；Reranker 用 bge-reranker 或替代。
- **服务层：**FastAPI（统一推理/检索接口）、LlamaIndex（流水线编排与路由）、重排与融合打分、事实校验。
- **前端层：**Streamlit（答案与证据链展示、图表重绘、导出）。
- **评测层：**RAGAs、BEIR 风格 IR 指标与合规模块。

## 模块设计与实现细节

### 数据预处理与多模态归一

- **PDF解析：**OCR（扫描件）+ 版面解析（标题/段落/表图标签），保留页码与图号。
- **图表/表格检测：**对象检测（DETR/YOLO）截取图片块。
- **LVLM 转换：**将图片块转 Markdown 表，并输出自然语言要点说明；失败时走 OCR+规则模板降级。
- **实体/关系抽取：**用 LLM 抽取三元组（公司/指标/时间/数值/来源），构建知识图谱。
- **入库规范：**
  - **Milvus：**文本块、Markdown表和要点描述生成 dense 向量，配合 sparse（BM25/倒排）；元数据包含页码/图号/来源/日期。
  - **NebulaGraph：**定义点（Issuer、Instrument、Metric、Time、Value、Region）与边（reports、belongs_to、affects、correlates），保留反向指针（页码/图号）。

### 检索与精排融合

- **混合召回：**bge-m3（或替代）生成 dense 嵌入；BM25 生成 sparse；top-k 合并。
- **图谱检索：**解析查询中的实体，检索邻域与路径，补充结构化关系证据。
- **精排器：**bge-reranker-large（或 cross-encoder 替代）对向量候选做交叉编码重排。
- **融合打分：**S = w1·Sdense + w2·Ssparse + w3·Sgraph，按任务场景配置权重（数据问答偏向量，研究洞见偏图谱）。
- **事实校验：**LLM 对向量与图谱候选分别核验，一致性不足的上下文剔除后合并。

### 生成、可追溯与图表重绘

- **提示模板约束：**强制“结论+引用（页码/图号/来源）+不确定性说明”；禁止臆断缺失数据。
- **证据链输出：**答案嵌证据卡片（原文摘录、Markdown表、关键数据点），前端可展开与导出 ZIP。
- **图表重绘：**将 Markdown 表转换为 ECharts/Altair 可视化，支持交互（tooltip/筛选/下载）。

### 批量摘要与评测集构建

- **批处理：**新入库 PDF 自动生成摘要卡片/指标表/问答三元组（LLM 生成+人工审核）。
- **评测集：**覆盖简单/推理/多上下文比例，支撑 RAGAs 与 IR 指标评测。

### 联邦协作与合规

- **共享内容：**索引摘要、实体词表、精排器权重、提示模板版本；不共享原文与敏感字段。
- **隐私与合规：**字段脱敏、私有部署、接口鉴权（JWT/OIDC）、日志审计、生成合规提示。

### 模型适配与服务骨架

- **LVLM（图片→Markdown）：**Qwen2-VL 或 InternVL 的 MindSpore/MindFormers 适配版，跑在 910B；失败时降级到 OCR+规则。
- **LLM（生成/事实校验）：**Qwen2/GLM 系列 910B 适配版。
- **Embedding/Reranker：**优先 bge-m3/bge-reranker 的 Ascend 版本；缺失时用 MindSpore 中文嵌入模型 + BM25、cross-encoder 替代。
- **FastAPI（推理接口）：**
  - **/convert_chart_table：**图片→Markdown 表。
  - **/embed：**文本块与 Markdown 嵌入生成。
  - **/query：**混合检索与精排、事实校验、答案与证据链输出。
  - **/ingest：**PDF 摄取与分块、入库。
  - **/federated/{push|pull}：**联邦共享索引摘要与权重。

### LlamaIndex 编排与 Milvus/NebulaGraph 对接

- **流水线 DAG：**multi-vector retriever（dense+sparse）→ graph retriever → reranker → fact-checker → response synthesizer。
- **Milvus：**建库/建索引（向量维度与度量选择：cosine/dot），插入嵌入与元数据。
- **NebulaGraph：**点/边 schema 与 nGQL 查询封装，检索实体邻域与路径。

### Flower 联邦部署

- **客户端：**各部门独立 ingest/embedding/graph index；定时联邦索引摘要与词表。
- **主控：**聚合策略（加权平均/版本选择）、租户隔离路由，下发更新。

## 评测指标与验收标准

- **RAGAs：**忠实度（faithfulness）、答案相关性（answer relevancy）、上下文精准/召回、端到端相似度与正确率。
- **IR 指标（向量检索）：**nDCG/MAP/Recall/Precision@3/5/10，进行消融对比（开启/关闭图片转换、图谱、重排、事实校验）。
- **合规与审计：**数据不出域、接口鉴权、日志审计、字段脱敏、生成合规提示；证据链完整可导出与复核。
- **安全性：**实现租户级隔离、策略命中准确、全链路可追溯与联邦协作受控。
- **可用性：**完成多模态解析与混合检索闭环，答案具备证据链与可视化验证。
- **国产化：**在昇腾 910B 与国产软件栈稳定运行，性能与合规指标达标且可持续评测

- ## 权限管理与协作机制

  系统在设计上引入多层次的权限管理机制。不同部门、不同角色拥有差异化的访问权限，敏感数据需经过严格的策略判定与审批流程。访问控制不仅基于角色，还结合用户属性、资源敏感等级、访问环境等动态因素，实现细粒度的策略执行。所有操作均记录日志，生成可追溯的审计链路。

  在跨部门协作场景下，系统通过联邦学习与索引共享机制，实现“数据不出域”的前提下的知识协同。各部门仅共享索引摘要、实体词表或模型权重，而不直接交换原始文档，从而在保证合规的同时提升整体智能水平。

- ## 国产化与工程化

  - **硬件适配：**在昇腾 910B NPU 上完成 LLM/VLM 推理与优化；对不可适配模块提供可降级路径与迭代迁移计划。
  - **软件生态：**采用 MindSpore/MindFormers、Milvus、NebulaGraph、国产对象存储与容器平台，统一国产栈。
  - **国密加固：**全链路 TLS 与静态加密采用 SM2/SM3/SM4，私钥托管于国产硬件安全模块。
  - **稳定运行与评测：**建立 RAGAs 与 IR 指标的自动评测流水线，提供性能压测（QPS/延迟/稳态）与异常注入演练

## 技术栈

- **Flower FedRAG：**用于索引摘要/实体词表/重排权重的联邦共享，不共享原文；支持租户隔离。

- **Streamlit：**问答 UI、证据链展开与导出、图表重绘及下载。

- **FastAPI：**统一接口分层（ingest/embed/query/convert/federated），便于后期扩展与审计。

- **LlamaIndex：**搭建混合检索与事实校验的 DAG，简化路由与合并逻辑。

- **Milvus/NebulaGraph：**分别承载多模态向量检索与结构化关系检索，提升复杂问题的可解释性与准确性。

- ## 运营与治理

  - **生命周期管理：**覆盖入库、索引、图谱、模型、策略与审计的版本化与灰度发布，支持快速回滚。
  - **风险控制：**对越权、异常地理/设备访问、数据外流迹象进行实时识别与熔断，联动审批与冻结策略。
  - **可维护性：**以统一 API 网关与编排框架提供标准化接口，输出运维与监控指标，支持多环境一致化部署。

  ## 应用与价值

  该方案能够在金融研究、投资决策、风险管理等多个场景中发挥作用。研究人员可以快速检索并验证研报中的数据与结论；投资经理能够基于图表与表格的结构化信息进行趋势分析；风控部门则可以在严格权限控制下访问敏感数据并生成合规报告。系统的可追溯性与审计能力，为合规监管提供了有力支撑。